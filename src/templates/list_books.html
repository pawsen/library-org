<!-- templates/list_books.html -->
{% block inlinecss %}
<style type="text/css">
    .sortable {
        cursor: pointer;
    }

    .sortable.asc::after {
        content: " ↑";
    }

    .sortable.desc::after {
        content: " ↓";
    }

    .book-section-entry-container {
        margin-bottom: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        /* Add a separator between rows */
    }

    .book-section-entry-container p {
        margin: 0;
        word-wrap: break-word;
        /* Ensure long text wraps */
    }

    .book-section-headers {
        font-weight: bold;
        padding: 10px 0;
        border-bottom: 2px solid #ddd;
        /* Add a separator for headers */
    }

    /* Keep page numbers and Prev/Next on the same line */
    .pagination-controls {
        display: flex;
        flex-wrap: wrap;
        /* allows wrap only on very small screens */
        justify-content: center;
        /* center whole block */
        align-items: center;
    }

    /* Page numbers block */
    .pagination-controls .pages-list {
        flex: 0 0 auto;
        display: inline-block;
        margin-right: 6px;
        /* small gap before Prev/Next */
    }

    /* Prev/Next block */
    .pagination-controls>nav {
        flex: 0 0 auto;
        display: inline-block;
        margin: 0;
    }

    /* Make sure the inner .nav doesn't stretch full width */
    .pagination-controls>nav .nav {
        display: inline-flex;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .pagination-controls>nav .nav>li {
        float: none;
    }

    /* Prev/Next in pagination: same tiny pills as detail-nav */
    .pagination-controls>nav .nav>li>a.nav-link,
    .pagination-controls>nav .nav>li>span.nav-link {
        display: inline-block;
        padding: 1px 6px;
        /* smaller padding */
        font-size: 0.7rem;
        /* smaller text */
        line-height: 1.2;
        border-radius: 999px;

        background-color: #337ab7;
        color: #fff;
        border: 1px solid #2e6da4;
        text-decoration: none;
        width: auto;
        float: none;
    }

    .pagination-controls>nav .nav>li>a.nav-link:hover,
    .pagination-controls>nav .nav>li>a.nav-link:focus {
        background-color: #286090;
        border-color: #204d74;
        color: #fff;
        text-decoration: none;
    }

    /* Disabled Prev/Next */
    .pagination-controls>nav .nav>li>span.nav-link.disabled {
        background-color: #ccc;
        border-color: #bbb;
        color: #666;
        cursor: default;
        pointer-events: none;
    }

    /* Put the 4 sortable headers on one horizontal line */
    /*****************************************************/
    .book-section-headers {
        display: flex;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
    }

    /* Override Bootstrap column behavior inside the header row */
    .book-section-headers>div {
        float: none;
        /* kill Bootstrap float */
        width: auto;
        /* let flex handle widths */
        flex: 1 1 0;
        padding-left: 4px;
        padding-right: 4px;
    }

    /* Make the header links compact so they don't wrap easily */
    .book-section-headers a.sortable {
        display: block;
        font-size: 0.85rem;
        white-space: nowrap;
    }
</style>
{% endblock %}


{% if books.items %}
  <!-- Pagination Controls -->
  {% if books.pages > 1 %}
    <div class="row">
      <div class="col-xs-12">
        <div class="pagination-controls">
          <!-- Pages List (smart page numbers) -->
          <div class="pages-list">
            {% set total = books.pages %}
            {% set current = books.page %}

            {% if total <= 9 %}
              {# Few pages: show all #}
              {% for page in range(1, total + 1) %}
                {% if page == current %}
                  <span class="paginate-pagenumber-container">{{ page }}</span>
                {% else %}
                  <a class="paginate-pagenumber-container"
                     href="{{ url_for('index',
                                      page=page,
                                      s=s,
                                      sort_by=sort_by,
                                      sort_order=sort_order,
                                      per_page=per_page) }}">
                    {{ page }}
                  </a>
                {% endif %}
              {% endfor %}
            {% else %}
              {# Many pages: always show 1 and last, window = (current-1) .. (current+3) #}

              {# --- Page 1 --- #}
              {% if current == 1 %}
                <span class="paginate-pagenumber-container">1</span>
              {% else %}
                <a class="paginate-pagenumber-container"
                   href="{{ url_for('index',
                                    page=1,
                                    s=s,
                                    sort_by=sort_by,
                                    sort_order=sort_order,
                                    per_page=per_page) }}">
                  1
                </a>
              {% endif %}

              {# Compute window [start_page, end_page] within [2, total-1] #}
              {% set start_page = current - 1 %}
              {% set end_page = current + 3 %}

              {% if start_page < 2 %}
                {% set start_page = 2 %}
              {% endif %}
              {% if end_page > total - 1 %}
                {% set end_page = total - 1 %}
              {% endif %}

              {# Ellipsis after 1 if needed #}
              {% if start_page > 2 %}
                <span class="paginate-pagenumber-container">…</span>
              {% endif %}

              {# Window pages: current-1, current, current+1, current+2, current+3 (clamped) #}
              {% for page in range(start_page, end_page + 1) %}
                {% if page == current %}
                  <span class="paginate-pagenumber-container">{{ page }}</span>
                {% else %}
                  <a class="paginate-pagenumber-container"
                     href="{{ url_for('index',
                                      page=page,
                                      s=s,
                                      sort_by=sort_by,
                                      sort_order=sort_order,
                                      per_page=per_page) }}">
                    {{ page }}
                  </a>
                {% endif %}
              {% endfor %}

              {# Ellipsis before last if needed #}
              {% if end_page < total - 1 %}
                <span class="paginate-pagenumber-container">…</span>
              {% endif %}

              {# --- Last page --- #}
              {% if current == total %}
                <span class="paginate-pagenumber-container">{{ total }}</span>
              {% else %}
                <a class="paginate-pagenumber-container"
                   href="{{ url_for('index',
                                    page=total,
                                    s=s,
                                    sort_by=sort_by,
                                    sort_order=sort_order,
                                    per_page=per_page) }}">
                  {{ total }}
                </a>
              {% endif %}
            {% endif %}
          </div>

          <!-- Navigation Bar with Prev and Next Buttons -->
          <nav>
            <ul class="nav">
              <!-- Previous Page Link -->
              <li class="nav-item">
                {% if books.has_prev %}
                  <a href="{{ url_for('index',
                                      page=books.prev_num,
                                      s=s,
                                      sort_by=sort_by,
                                      sort_order=sort_order,
                                      per_page=per_page) }}"
                     class="nav-link">
                    Prev
                  </a>
                {% else %}
                  <span class="nav-link disabled">Prev</span>
                {% endif %}
              </li>

              <!-- Next Page Link -->
              <li class="nav-item">
                {% if books.has_next %}
                  <a href="{{ url_for('index',
                                      page=books.next_num,
                                      s=s,
                                      sort_by=sort_by,
                                      sort_order=sort_order,
                                      per_page=per_page) }}"
                     class="nav-link">
                    Next
                  </a>
                {% else %}
                  <span class="nav-link disabled">Next</span>
                {% endif %}
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Table headers with sorting toggle -->
  <div class="row book-section-headers">
    <div class="col-xs-12 col-md-5">
      <a href="{{ url_for('index',
                          page=1,
                          s=s,
                          sort_by='title',
                          sort_order='asc' if sort_order == 'desc' else 'desc',
                          per_page=per_page) }}"
         class="sortable {{ 'asc' if sort_by == 'title' and sort_order == 'asc' else 'desc' }}">
        Title
      </a>
    </div>
    <div class="col-xs-12 col-md-3">
      <a href="{{ url_for('index',
                          page=1,
                          s=s,
                          sort_by='authors',
                          sort_order='asc' if sort_order == 'desc' else 'desc',
                          per_page=per_page) }}"
         class="sortable {{ 'asc' if sort_by == 'authors' and sort_order == 'asc' else 'desc' }}">
        Author
      </a>
    </div>
    <div class="col-xs-12 col-md-2">
      <a href="{{ url_for('index',
                          page=1,
                          s=s,
                          sort_by='location',
                          sort_order='asc' if sort_order == 'desc' else 'desc',
                          per_page=per_page) }}"
         class="sortable {{ 'asc' if sort_by == 'location' and sort_order == 'asc' else 'desc' }}">
        Location
      </a>
    </div>
    <div class="col-xs-12 col-md-2">
      <a href="{{ url_for('index',
                          page=1,
                          s=s,
                          sort_by='subjects',
                          sort_order='asc' if sort_order == 'desc' else 'desc',
                          per_page=per_page) }}"
         class="sortable {{ 'asc' if sort_by == 'subjects' and sort_order == 'asc' else 'desc' }}">
        Subjects
      </a>
    </div>
  </div>

  <!-- Book entries -->
  {% for book in books.items %}
    <div class="row book-section-entry-container">
      <div class="col-xs-12 col-md-5">
        <a href="{{ url_for('detail', id=book[0].id) }}">{{ book[0].title }}</a>
      </div>
      <div class="col-xs-12 col-md-3">
        <p>{{ book[0].authors }}</p>
      </div>
      <div class="col-xs-12 col-md-2">
        <p>{{ book[1].label_name }}, {{ book[1].full_name }}</p>
      </div>
      <div class="col-xs-12 col-md-2">
        <p>{{ book[0].subjects }}</p>
      </div>
    </div>
  {% endfor %}

  <!-- Pagination Controls: Change number of items per page -->
  <div class="col-xs-12">
    <form method="get"
          action="{{ url_for(request.endpoint,
                             page=1,
                             s=s,
                             sort_by=sort_by,
                             sort_order=sort_order) }}">
      {% if s %}
        <input type="hidden" name="s" value="{{ s }}">
      {% endif %}
      <label for="per_page">Items per page:</label>
      <select name="per_page" id="per_page"
              class="form-control"
              onchange="this.form.submit()">
        <option value="50"  {% if per_page == 50  %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        <option value="1000"{% if per_page == 1000 %}selected{% endif %}>1000</option>
      </select>
    </form>
  </div>
{% else %}
  <p class="text-center">No results found.</p>
{% endif %}
