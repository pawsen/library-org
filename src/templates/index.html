{% extends "base.html" %}

{% block inlinecss %}
<style type="text/css">
</style>
{% endblock %}

{% block main %}
<!--
Bootstrap Grid System: Used col-xs-12 for mobile devices and col-md-* for
larger screens to ensure the layout adapts to different screen sizes.
-->
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12">
            <!-- <h3 class="explanation-header text-center">Search title, authors, and subjects above.</h3> -->

            <!-- Search Results -->
            <div id="search-results">
                {% include 'list_books.html' %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block inlinejs %}
<!-- JS for instant search -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search');
    const searchResults = document.getElementById('search-results');

    // Prefix-aware base path (e.g. "/apps/library")
    // XXX SCRIPT_ROOT is included for completeness; not needed if url_for() is always used for
    // endpoints.
    const SCRIPT_ROOT = {{ request.script_root|tojson }};
    const INDEX_PATH  = {{ url_for('index')|tojson }}; // e.g. "/apps/library/index/"

    const fetchSearchResults = async (url) => {
      try {
        const response = await fetch(url, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.text();
        searchResults.innerHTML = data;

        // Keep browser URL in sync (store only path+query)
        const u = new URL(url, window.location.origin);
        window.history.pushState({}, '', u.pathname + u.search);

        attachPaginationListeners();
      } catch (error) {
        console.error('Error fetching search results:', error);
      }
    };

    const debounce = (func, delay) => {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    };

    searchInput.addEventListener('input', debounce((event) => {
      const query = event.target.value.trim();
      const urlParams = new URLSearchParams(window.location.search);

      const currentPage = urlParams.get('page') || 1;
      const perPage = urlParams.get('per_page') || 50;

      // Build a prefix-aware URL safely
      const u = new URL(INDEX_PATH, window.location.origin);
      u.searchParams.set('page', currentPage);
      u.searchParams.set('per_page', perPage);
      if (query.length >= 2) u.searchParams.set('s', query);

      fetchSearchResults(u.toString());
    }, 300));

    const attachPaginationListeners = () => {
      const paginationLinks = document.querySelectorAll('.paginate-pagenumber-container, .nav-link');
      paginationLinks.forEach(link => {
        link.addEventListener('click', (event) => {
          event.preventDefault();
          const u = new URL(event.target.href, window.location.origin);
          fetchSearchResults(u.toString());
        });
      });
    };

    attachPaginationListeners();
  });
</script>
{% endblock %}
